<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>바나나 월드에서 살아남기 — 확장완성판</title>
<style>
  :root{
    --bg:#0b0b0c;
    --panel:#111216;
    --accent:#ffd54f;
    --muted:#bfc4c8;
    --glass: rgba(255,255,255,0.03);
    --danger:#ff6b6b;
  }
  html,body{
    height:100%; margin:0;
    font-family:Inter, "Noto Sans KR", system-ui, -apple-system,
      "Apple SD Gothic Neo", "Malgun Gothic", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:linear-gradient(180deg,#070708 0%, #111217 100%);
    color: #fff; -webkit-font-smoothing:antialiased;
  }
  .app{
    display:flex; flex-direction:column; height:100vh;
    padding:16px; box-sizing:border-box; max-width:900px; margin:0 auto;
  }
  header{display:flex; align-items:center; gap:12px;}
  .logo{
    width:56px; height:56px; border-radius:12px;
    background:linear-gradient(135deg,#fff2b8,#ffd54f);
    display:flex; align-items:center; justify-content:center;
    font-weight:800; color:#222; font-size:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  h1{font-size:18px; margin:0; letter-spacing:0.2px}
  .meta{margin-left:auto; text-align:right; font-size:12px; color:var(--muted);}
  main{flex:1; display:flex; flex-direction:column; gap:12px; margin-top:12px;}
  .panel{
    background:linear-gradient(180deg,var(--panel), #0e0e12);
    border-radius:16px; padding:16px;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    backdrop-filter:blur(6px); display:flex; flex-direction:column;
  }
  #story{
    flex:1; min-height:260px; font-size:16px; line-height:1.8;
    white-space:pre-wrap; opacity:1; transition:opacity .28s ease;
  }
  #meme{ width:100%; border-radius:10px; margin-top:12px; display:none; max-height:240px; object-fit:cover; border:1px solid rgba(255,255,255,0.03) }
  #choices{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
  .choice{
    padding:14px; border-radius:14px;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    font-size:16px; text-align:left; cursor:pointer;
    box-shadow:0 8px 24px rgba(0,0,0,0.45);
    color: #fff; width:100%;
  }
  .choice:active{ transform:translateY(2px); }
  .choice.small{ padding:10px; font-size:14px; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .stat{ font-size:13px; color:var(--muted); padding:8px 12px; border-radius:999px; background:var(--glass); border:1px solid rgba(255,255,255,0.03); }
  footer{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:12px; }
  .btn{ padding:10px 12px; border-radius:10px; background:var(--accent); color:#222; font-weight:800; border:none; cursor:pointer; box-shadow:0 10px 20px rgba(255,213,79,0.12); }
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
  .smalltext{ font-size:12px; color:var(--muted); }
  .log{ max-height:140px; overflow:auto; padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); font-size:13px; color:var(--muted); margin-top:12px; }
  .center{ display:flex; justify-content:center; align-items:center; }
  .hidden{ display:none; }
  @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-8px)} 50%{transform:translateX(8px)} 75%{transform:translateX(-6px)} 100%{transform:translateX(0)} }
  .shake { animation:shake .45s ease; }
  @media (max-width:520px){ .choice{ font-size:17px; padding:16px; border-radius:14px; } h1{ font-size:16px; } }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">BN</div>
    <h1>바나나 월드에서 살아남기 — 확장완성판</h1>
    <div class="meta">
      <div id="timePlayed">플레이: 0초</div>
      <div id="progressText">진행: 0%</div>
    </div>
  </header>

  <main>
    <section class="panel" style="flex:1;display:flex;flex-direction:column;">
      <div id="story" aria-live="polite"></div>
      <img id="meme" alt="이미지 연출">
      <div id="choices"></div>
      <div class="log" id="log" aria-hidden="false"></div>
    </section>

    <section style="display:flex;flex-direction:column;gap:10px;">
      <div class="row">
        <div class="stat" id="statIdentity">정체: 사람</div>
        <div class="stat" id="statRepute">바나나 호감: 0</div>
        <div class="stat" id="statClues">단서: 0</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="restartBtn">처음부터</button>
        <button class="btn ghost" id="hintBtn">힌트</button>
        <button class="btn" id="exportBtn">HTML 다운로드</button>
      </div>
      <div class="smalltext center">팁: 선택은 은밀함 / 기발함 / 직면의 관점을 만듭니다. 모든 루트는 끝까지 연결됩니다.</div>
    </section>
  </main>

  <footer>
    <div class="smalltext">오프라인 실행 가능 — 새로고침 시 초기화됩니다.</div>
    <div class="smalltext">버전: 확장완성판 · 스토리·엔딩 강화</div>
  </footer>
</div>

<script>
/* --------------------------
   유틸 함수
   -------------------------- */
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function nowTime(){ return new Date().toLocaleTimeString(); }

/* meme 이미지 (랜덤 연출) */
const memes = [
  "https://i.imgur.com/4AiXzf8.gif",
  "https://i.imgur.com/8Ilt2rZ.gif",
  "https://i.imgur.com/0l5WnnT.gif",
  "https://i.imgur.com/6KcFQq8.jpg"
];

/* 상태 초기화 */
let state = {
  current: 'intro_wake',
  flags: {},
  repute: 0,
  clues: 0,
  timeStart: Date.now(),
  timePlayed: 0,
  history: []
};

function appendLog(text){
  const p = document.createElement('div');
  p.textContent = `[${nowTime()}] ${text}`;
  document.getElementById('log').prepend(p);
}

/* --------------------------
   스토리 데이터 (확장)
   - 모든 노드는 충분한 서술(최소 ~5문장)
   - 선택은 effect로 상태 변경
   -------------------------- */
const story = {
  intro_wake: {
    title: '깨어난 아침',
    text:
`눈을 뜨니 모든 것이 노랗다. 벽은 껍질처럼 부드럽고, 공기엔 달콤한 향이 떠돈다.
발밑에서는 가벼운 윙윙거림이 들리고, 멀리선 합창처럼 규칙적 소리가 흐른다.
전광판엔 '오늘의 등급'이 떠 있고, 지나가는 바나나들은 당신을 낯선 존재로 바라본다.
당신은 '인간'이다. 돌아가야 한다. 첫 선택이 앞으로의 운명을 엮어간다.`,
    choices:[
      { text:'숨어 관찰하기 — 안전한 접근', id:'hide_blend' },
      { text:'껍질로 위장해 섞이기 — 기발한 접근', id:'disguise_shell' },
      { text:'바나나에게 직접 묻기 — 정면 돌파', id:'ask_police' }
    ]
  },

  /* --------------- 숨기기 루트 --------------- */
  hide_blend: {
    title:'숨어 관찰',
    text:
`당신은 골목의 그림자 속에 웅크려 바나나들의 생활을 관찰한다.
이 사회는 외형과 규범에 민감하고, 작은 실수 하나가 곧 불신으로 이어진다.
시장의 잡담 속에 '포탈'에 대한 낮은 속삭임이 섞여 있었다 — 북쪽 관문.
포탈은 주로 신뢰와 단서를 요구한다는 말이 반복된다.
안전하지만 더디다. 어떻게 움직일 것인가?`,
    choices:[
      { text:'더 깊이 관찰해 단서 모으기', id:'observe_more' },
      { text:'작은 도움을 주며 호감 쌓기', id:'help_banana' }
    ]
  },

  observe_more: {
    title:'더 관찰하기',
    text:
`당신은 시장, 광장, 작은 기계실까지 하루 종일 염탐한다.
바나나들의 손짓·인사법·색 배치 같은 규범들을 기록한다 — 이것들이 출입 허가의 열쇠일지도 모른다.
낡은 기록 보관소와 포탈의 구조를 이어주는 단서가 있다는 소문을 듣는다.
하지만 보관소는 높은 등급의 시민만 출입할 수 있다 — 기회를 만들어야 한다.
다음에 무엇을 할 것인가?`,
    choices:[
      { text:'호감 쌓기(도움 제공)', id:'help_banana', effect:(s)=>{ s.repute += 1; s.clues += 1; } },
      { text:'기회를 보고 기록 보관소 잠입', id:'sneak_library' }
    ]
  },

  help_banana: {
    title:'바나나 돕기',
    text:
`길에서 작은 바나나가 넘어졌다. 당신은 본능적으로 손을 내밀어 일으킨다.
그 바나나는 놀란 얼굴로 당신을 바라보다가 작게 속삭인다 — "의식에 관해 알아둬라."
그의 감사 표시로 작은 실마리 하나를 건네준다. 직접적인 답은 아니었지만 방향성이 생긴다.
호감이 오른다. 이 호감은 당신에게 문을 여는 단서가 될 수 있다.`,
    choices:[
      { text:'조용히 신뢰를 쌓는다(안전)', id:'build_trust', effect:(s)=>{ s.repute += 1; } },
      { text:'정보를 모아 포탈로 향한다(모험)', id:'go_to_portal' }
    ],
    effect:(s)=>{ s.repute += 1; }
  },

  sneak_library: {
    title:'기록 보관소 잠입',
    text:
`밤, 당신은 보관소 근처를 맴돈다. 경비의 동선을 기억한 대로 움직이면 틈이 보인다.
작은 창으로 오래된 지도와 기호들이 보이고, 포탈의 내부구조 일부를 해독할 수 있다.
그러나 발각되어 숨을 죽이며 도망쳐야 했다. 그래도 단서 한 조각을 손에 넣었다.
이것으로 무엇을 할 것인가?`,
    choices:[
      { text:'호감 쌓으러 돌아가기', id:'build_trust', effect:(s)=>{ s.clues += 1; } },
      { text:'지도를 가지고 포탈로 이동', id:'go_to_portal', effect:(s)=>{ s.clues += 1; } }
    ]
  },

  build_trust: {
    title:'신뢰 쌓기',
    text:
`며칠간 당신은 눈에 띄지 않게 봉사를 하고 작은 부탁을 들어준다.
바나나들은 당신의 도움을 기억하고, 몇몇은 추천서를 써주었다.
추천서는 안내원에게 제출 가능하며, 안내원은 비밀의 통로에 대해 이야기해줄지도 모른다.
지루하지만 안정적인 길이다. 당신은 이 길을 계속 걷겠는가, 아니면 속도를 올리겠는가?`,
    choices:[
      { text:'안내원에게 부탁한다', id:'seek_guide' },
      { text:'마지막 준비를 마치고 포탈로 향한다', id:'go_to_portal' }
    ],
    effect:(s)=>{ s.repute += 1; }
  },

  seek_guide: {
    title:'안내원과의 약속',
    text:
`안내원은 검은 모자를 쓴 바나나였다. 그는 여러 추천서를 들여다보며 고개를 끄덕인다.
"우리는 외부인을 환영하지는 않지. 하지만 네 마음이 참되다면 도울 수 있다." 그는 신뢰의 표식과 단서의 결합을 요구한다.
작은 의식에 참여하라 권유한다. 위험을 감수하겠는가?`,
    choices:[
      { text:'의식에 참여해 표식 얻기', id:'ritual' },
      { text:'의식을 피하고 포탈을 노린다', id:'go_to_portal' }
    ]
  },

  ritual: {
    title:'신뢰의 의식',
    text:
`의식은 외형적 단장과 내면의 고백으로 구성되어 있다. 참가자들은 각자의 진심을 말한다.
당신은 인간임을 밝히느냐, 아니면 숨기느냐 선택해야 한다 — 둘 다 결과를 낳는다.
정직함은 더 큰 신뢰를, 위장은 제한된 통과를 준다. 순간의 선택이 곧 귀환의 가능성을 좌우한다.
어떻게 답할 것인가?`,
    choices:[
      { text:'정직하게 고백하고 표식 받기', id:'honest_ritual', effect:(s)=>{ s.repute += 2; s.clues += 1; s.flags.honestRitual = true; } },
      { text:'정체를 숨기고 의식을 통과', id:'fake_ritual', effect:(s)=>{ s.repute += 1; s.flags.fakeRitual = true; } }
    ]
  },

  honest_ritual: {
    title:'정직의 보상',
    text:
`당신은 인간임을 고백했다. 장내에는 잠깐의 침묵이 흐르고, 이내 따뜻한 박수가 번진다.
진심을 본 그들은 작은 금속 흉패를 건넨다 — '신뢰의 표식'이다. 이 표식은 심사대에서 유효하게 작동할 것이다.
마지막 준비를 하고 북쪽 관문으로 향한다. 이제 모든 것이 결말을 향해 모인다.`,
    choices:[
      { text:'북쪽 관문으로 향한다', id:'go_to_portal' }
    ]
  },

  fake_ritual: {
    title:'속임의 통과',
    text:
`당신은 평정심을 유지하며 의식을 통과했다. 표식 비슷한 장신구를 받았지만, 그것은 완전한 신뢰를 담보하지 못한다.
일부 관찰자들은 여전히 눈썰미 있게 당신을 주시한다. 편리하지만 위험한 길이다.
포탈에 도달해서야 장신구의 한계가 드러날 수 있다. 전진하겠는가?`,
    choices:[
      { text:'바로 포탈로 향한다', id:'go_to_portal' },
      { text:'잠시 더 호감 쌓기', id:'help_banana', effect:(s)=>{ s.repute += 1; } }
    ]
  },

  /* --------------- 위장 루트 --------------- */
  disguise_shell: {
    title:'껍질 위장',
    text:
`버려진 껍질을 주워 머리에 덮어쓴다. 걸음걸이와 손짓을 흉내내기에 당신의 몸은 어색하다.
위장 덕분에 시장과 광장에 쉽게 접근할 수 있고, 바나나들의 사적인 대화를 엿볼 기회가 생긴다.
그러나 위장은 늘 불완전하다. 미세한 차이는 언제든 포착될 수 있다.
이제 자연스럽게 섞일 것인가, 혹은 과장된 매력으로 눈에 띌 것인가?`,
    choices:[
      { text:'자연스럽게 섞여 정보 수집', id:'stay_natural' },
      { text:'껍질을 장식해 과감히 주목받기', id:'decorate_shell' }
    ]
  },

  stay_natural: {
    title:'자연스러운 흉내',
    text:
`당신은 최대한 자연스럽게 행동하려 한다. 어눌한 제스처가 나오지만 진심은 통한다.
몇몇 바나나는 호기심을 보이며 작은 단서를 흘려준다. 위장의 장점은 정보 접근성이다.
이 지식을 활용하면 포탈 접근이 쉬워질 수도 있다. 어떻게 활용할 것인가?`,
    choices:[
      { text:'단서로 포탈 시도(하이브리드 가능)', id:'attempt_portal_hybrid', effect:(s)=>{ s.clues += 1; } },
      { text:'더 호감을 모으기', id:'help_banana', effect:(s)=>{ s.repute += 1; } }
    ]
  },

  decorate_shell: {
    title:'과장된 위장',
    text:
`껍질에 화려한 장식을 붙이고 큰 제스처로 관심을 끈다. 사람들의 시선이 집중된다.
이 정책은 빠른 정보와 예기치 않은 도움을 가져오기도 하지만, 감시 또한 늘어난다.
당신이 얻는 것은 속도, 잃는 것은 은밀함이다. 큰 보상을 노릴 것인가, 리스크를 줄일 것인가?`,
    choices:[
      { text:'포탈로 돌진 — 성패 불명', id:'attempt_portal_hybrid', effect:(s)=>{ s.repute += 1; s.clues += 1; } },
      { text:'숨고 더 관찰', id:'observe_more' }
    ]
  },

  attempt_portal_hybrid: {
    title:'포탈 시도(하이브리드)',
    text:
`준비는 일부였고, 포탈은 당신을 반쯤만 받아들였다. 빛이 일렁이고 몸의 일부가 변한다.
인간의 이성과 바나나의 외형이 섞여, 새로운 감각과 혼란이 찾아온다.
이 결과는 자유와 소외를 동시에 준다 — 두 세계에 완전히 속하지 못하는 존재가 된다.
이제, 이 상태로 살아갈 것인가 아니면 다시 도전할 것인가?`,
    choices:[
      { text:'새로운 삶을 받아들인다(하이브리드 엔딩)', id:'ending_hybrid' },
      { text:'다시 시작', id:'intro_wake' }
    ],
    effect:(s)=>{ s.flags.hybridEnding = true; }
  },

  /* --------------- 정면 대면 루트 --------------- */
  ask_police: {
    title:'직접 묻기',
    text:
`당신은 바나나 경찰에게 다가가 이 세계의 성질을 묻는다. 경찰은 호기심과 경계를 동시에 보인다.
검사와 질문이 이어지고, 당신은 연구소로 이송될 위험과 기회를 동시에 마주한다.
직접 대면은 빠른 이동을 제공하지만 통제된 실험의 대상이 될 수 있다.
당신은 솔직히 협력할 것인가, 속임수로 시간을 벌 것인가?`,
    choices:[
      { text:'정직하게 고백', id:'confess_human' },
      { text:'거짓말로 시간 벌기', id:'lie_allergy' }
    ]
  },

  confess_human: {
    title:'정직한 제안',
    text:
`"저는 사람입니다." 당신은 숨김없이 고백한다. 토론 끝에 과학자는 실험과 협력을 제안한다.
성공하면 귀환을 돕겠다는 약속이 있다. 하지만 실패하면 변형의 위험이 따른다.
당신은 위험을 감수하여 귀환을 택하겠는가? 아니면 도망을 선택하겠는가?`,
    choices:[
      { text:'자발적으로 실험에 참여', id:'meet_scientist', effect:(s)=>{ s.repute += 1; s.clues += 1; } },
      { text:'거부하고 탈출 시도', id:'escape_lab' }
    ]
  },

  lie_allergy: {
    title:'기만의 시간',
    text:
`"껍질 알레르기입니다." 라고 둘러댄다. 일시적으로 의심을 피할 수 있지만, 언젠가 진실이 드러날 수 있다.
연구소로 옮겨져 더 정밀한 검사를 받을 가능성이 높아진다.
시간을 버는 대신 신뢰를 잃을 위험이 커진다. 이번에는 어떻게 하겠는가?`,
    choices:[
      { text:'실험을 허용하여 연장된 기회 얻기', id:'meet_scientist', effect:(s)=>{ s.clues += 1; } },
      { text:'기습 탈출 시도', id:'escape_lab' }
    ]
  },

  meet_scientist: {
    title:'과학자와의 협력',
    text:
`과학자는 친절하지만 목적이 분명하다. 포탈의 작동 원리를 밝힐 수 있다면 귀환을 돕겠다는 제안이다.
실험은 성공 가능성과 실패 위험을 모두 내포한다. 일부 피실험자는 변형되었다는 전례가 있다.
결정은 당신의 준비와 용기에 달려있다. 참여하겠는가?`,
    choices:[
      { text:'실험 수락 — 안정화 시 귀환 가능', id:'experiment' },
      { text:'거부하고 탈출 시도', id:'escape_lab' }
    ],
    effect:(s)=>{ s.repute += 1; }
  },

  experiment: {
    title:'실험 시작',
    text:
`기계가 감싸고, 빛이 맥동한다. 데이터가 뿜어나오고 감각은 극도로 예민해진다.
눈앞에는 두 갈래의 이미지가 번갈아 보인다: 인간 세계로 돌아가는 문과 이완된 바나나 사회.
기계는 입력(단서·신뢰)에 민감하다. 이제 전송을 시도한다.`,
    choices:[
      { text:'전송 시도', id:'experiment_result' }
    ]
  },

  experiment_result: {
    title:'실험 결과',
    text:
`빛이 잦아들고, 몸은 전과 다를 수 있다. 결과는 당신이 준비한 정도에 따라 달라진다.
- 충분한 단서(2+)와 신뢰(3+)가 충족되면: 장비는 안정화되어 인간 세계로 귀환이 가능하다.
- 중간 수준의 준비가 있으면: 부분 변형으로 하이브리드 상태가 된다.
- 준비가 부족하면: 완전 동화되어 이곳의 일원이 된다.
결과는 운명이다. 당신의 결정을 확인하라.`,
    choices:[
      { text:'결과 확인', id:'finalize' }
    ],
    effect:(s)=>{
      if ((s.repute >= 3 && s.clues >= 2) || s.flags.honestRitual) s.flags.safeEnding = true;
      else if (s.flags.hybridEnding || (s.repute >= 1 && s.clues >= 1 && Math.random() > 0.45)) s.flags.hybridEnding = true;
      else s.flags.bananaEnding = true;
    }
  },

  escape_lab: {
    title:'연구소 탈출 시도',
    text:
`당신은 창틀과 통로를 이용해 탈출을 시도한다. 긴박한 추격극 끝에 외곽으로 도망친다.
자유를 얻었지만 귀환에 중요한 단서를 잃었을 가능성이 크다.
이제 선택지는 은둔해 다시 계획을 세울 것인지, 포탈을 향해 무모하게 돌진할 것인지다.
당신의 다음 행동은 무엇인가?`,
    choices:[
      { text:'숨어 계획을 재정비', id:'hide_blend' },
      { text:'직접 북쪽 관문으로 급행', id:'go_to_portal' }
    ]
  },

  /* --------------- 포탈 공통 --------------- */
  go_to_portal: {
    title:'포탈 접근',
    text:
`북쪽 관문은 거대하고 금빛의 문장으로 장식되어 있다. 심사대와 의식 장소가 주변을 둘러싼다.
당신의 준비(단서·표식·신뢰)에 따라 관문은 반응하거나 경고를 내린다.
이 순간, 지난 선택들이 모두 모여 결말을 결정한다. 마지막 결정을 내리라.`,
    choices:[
      { text:'관문 의식에 응하고 통과 시도', id:'portal_attempt' },
      { text:'주변을 더 살펴 단서를 활용', id:'use_clues' }
    ]
  },

  use_clues: {
    title:'단서 활용',
    text:
`당신은 모은 단서와 표식을 꺼내 심사대에 제출한다. 심사관은 꼼꼼히 살핀다.
충분하면 관문은 흔들리며 통로를 연다. 불충분하면 제지가 따른다.
마지막 순간의 진심이 영향을 줄 수 있다 — 선택은 중요한 순간이다.`,
    choices:[
      { text:'단서 제출', id:'portal_attempt', effect:(s)=>{ /* noop */ } },
      { text:'진심을 보이며 도전(의식 재시도)', id:'ritual' }
    ]
  },

  portal_attempt: {
    title:'문 통과 시도',
    text:
`관문이 당신을 받아들이거나 거부한다. 결과는 이전의 축적된 수치와 플래그에 달려있다.
- 충분한 신뢰(3+)와 단서(2+)면: 부드럽게 열려 인간 세계로 귀환 가능.
- 중간이면: 부분 변형되어 하이브리드 상태가 된다.
- 거의 준비되지 않으면: 완전 동화되어 바나나 사회의 일부가 된다.
당신의 결말을 맞이하라.`,
    choices:[
      { text:'결과 보기', id:'finalize' }
    ],
    effect:(s)=>{
      if (s.repute >= 3 && s.clues >= 2) s.flags.safeEnding = true;
      else if (s.repute >= 1 && s.clues >= 1) s.flags.hybridEnding = true;
      else s.flags.bananaEnding = true;
    }
  },

  finalize: {
    title:'결말',
    text:
`빛이 널 감싼다. 지금까지의 모든 선택과 쌓인 흔적이 한 줄기로 합쳐진다.
당신의 운명은 이제 확정된다. 어떤 결말이 펼쳐질까?`,
    choices:[
      { text:'결말 보기', id:'show_ending' }
    ]
  },

  show_ending: {
    title:'엔딩 전개',
    text:
`결과는 당신이 쌓아온 것들에 따라 다르다. 잠시 숨을 고르고 결과를 받아들여라.
(다음 단계에서 당신의 엔딩과 에필로그가 펼쳐진다.)`,
    choices:[
      { text:'엔딩 확인', id:'ending_router' }
    ]
  },

  /* --------------- 엔딩 결정 라우터(내부용) --------------- */
  ending_router: {
    title:'엔딩 라우팅',
    text:
`운명이 결정됩니다...`,
    choices:[
      // 비어있음. 선택 처리 로직에서 분기 후 실제 엔딩 노드로 이동합니다.
    ]
  },

  /* --------------- 실제 엔딩 노드 --------------- */
  ending_safe: {
    title:'안전 귀환',
    text:
`빛이 잦아들자, 당신은 다시 인간 세계의 공기 속에 서 있다. 집의 냄새, 차 소리, 익숙한 불빛.
바나나 월드에서의 기억은 오히려 삶의 새로운 눈금이 된다 — 연민과 관찰의 힘.
당신은 돌아왔지만 달라진 사람이다. 그곳에서의 약속, 흉패, 그리고 만났던 얼굴들을 가끔 떠올린다.
에필로그: 당신은 이후 그 경험을 책으로 남기거나, 연구로 발전시켜 다른 이들을 도운다.`,
    choices:[
      { text:'다시 시작', id:'intro_wake' }
    ]
  },

  ending_hybrid: {
    title:'하이브리드 — 두 세계 사이',
    text:
`당신은 두 세계의 흔적을 가진 존재로 남았다. 때로 인간의 이성이, 때로 바나나의 감각이 우선한다.
당신의 삶은 독특한 서사를 가진다 — 양쪽 모두의 일부로서 소속감을 찾으려 애쓴다.
새로운 능력과 새로운 고독이 공존한다. 사람들은 당신을 호기심과 경외로 바라본다.
에필로그: 당신은 경계에 선 안내자처럼 두 세계를 오가며 길을 안내하거나, 스스로 새로운 공동체를 쌓는다.`,
    choices:[
      { text:'다시 시작', id:'intro_wake' }
    ]
  },

  ending_banana: {
    title:'완전 동화(바나나화)',
    text:
`빛이 당신을 완전히 데려갔고, 당신은 바나나 사회의 일원이 되었다.
초반의 낯섦은 점차 편안함으로 바뀌었다. 새로운 관습, 새로운 친구들, 새로운 소속.
하지만 인간 세계의 일부 기억은 가끔 가슴 깊이 남아 아련한 그리움으로 다가온다.
에필로그: 당신은 새로운 가치를 받아들이고, 때로는 잃어버린 것들에 대해 노래한다.`,
    choices:[
      { text:'다시 시작', id:'intro_wake' }
    ]
  },

  ending_heroic: {
    title:'영웅적 희생(특별 엔딩)',
    text:
`어떤 선택은 단순한 귀환을 넘어 다른 이를 살리는 길을 택하게 한다.
당신은 포탈을 안정시키기 위해 자신을 희생했고, 그 덕에 다수의 바나나들이 안전을 얻었다.
당신의 이름은 그곳에서 전설처럼 남고, 인간 세계에서는 잔잔한 영향으로 남는다.
에필로그: 당신의 행적은 노래와 이야기로 이어지며, 세계 양쪽에 작은 평화를 남긴다.`,
    choices:[
      { text:'다시 시작', id:'intro_wake' }
    ]
  }
};

/* --------------------------
   렌더링 및 선택 처리
   -------------------------- */
const storyEl = document.getElementById('story');
const choicesEl = document.getElementById('choices');
const memeEl = document.getElementById('meme');
const logEl = document.getElementById('log');
const timePlayedEl = document.getElementById('timePlayed');
const progressText = document.getElementById('progressText');
const statRepute = document.getElementById('statRepute');
const statClues = document.getElementById('statClues');
const statIdentity = document.getElementById('statIdentity');

function renderHUD(){
  state.timePlayed = Math.floor((Date.now() - state.timeStart)/1000);
  timePlayedEl.textContent = `플레이: ${state.timePlayed}s`;
  const visited = new Set(state.history.concat([state.current]));
  progressText.textContent = `진행: ${Math.min(100, Math.floor((visited.size / Object.keys(story).length)*100))}%`;
  statRepute.textContent = `바나나 호감: ${state.repute || 0}`;
  statClues.textContent = `단서: ${state.clues || 0}`;
}

function render(){
  if (!state.current) state.current = 'intro_wake';
  // 엔딩 라우팅 처리: ending_router 일 때 플래그 기반으로 실제 엔딩으로 이동
  if (state.current === 'ending_router') {
    if (state.flags.heroic) state.current = 'ending_heroic';
    else if (state.flags.safeEnding) state.current = 'ending_safe';
    else if (state.flags.hybridEnding) state.current = 'ending_hybrid';
    else if (state.flags.bananaEnding) state.current = 'ending_banana';
    else {
      // 기본 fallback: 랜덤으로 하이브리드 또는 바나나 엔딩
      state.current = (Math.random() > 0.4) ? 'ending_hybrid' : 'ending_banana';
    }
  }

  const node = story[state.current];
  renderHUD();

  if (!node) {
    storyEl.textContent = '오류: 해당 씬이 존재하지 않습니다.';
    choicesEl.innerHTML = '<div class="choice small">게임 오류. 처음으로 돌아갑니다.</div>';
    return;
  }

  // 텍스트 전환 애니메이션
  storyEl.style.opacity = 0;
  setTimeout(()=>{
    storyEl.textContent = node.text;
    storyEl.style.opacity = 1;
  }, 140);

  // 가끔 이미지 연출
  if (Math.random() < 0.12) {
    memeEl.src = rand(memes);
    memeEl.style.display = 'block';
  } else {
    memeEl.style.display = 'none';
  }

  // 선택 생성
  choicesEl.innerHTML = '';
  if (node.choices && node.choices.length) {
    node.choices.forEach(c=>{
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.innerText = c.text;
      btn.onclick = ()=> choose(c);
      choicesEl.appendChild(btn);
    });
  } else {
    // 안전장치: 노드에 선택이 없으면 다시 시작 버튼 생성
    const b = document.createElement('button');
    b.className = 'choice small';
    b.innerText = '다시 시작';
    b.onclick = ()=> { state.current = 'intro_wake'; render(); };
    choicesEl.appendChild(b);
  }
}

/* 선택 처리: effect 실행, 기록, 현재 노드 변경 등 */
function choose(choice){
  if (choice.effect && typeof choice.effect === 'function') {
    try { choice.effect(state); }
    catch(e){ console.error(e); }
  }

  // 특수: portal_attempt / experiment_result 등 일부 노드는 내부에서 flags를 설정한다.
  state.history.push(state.current);
  state.current = choice.id;

  // 일부 노드에서 'finalize' -> 'ending_router'로 강제 이동 처리
  if (state.current === 'finalize') {
    // finalize의 effect가 이미 flags를 설정했을 수 있다.
    // 안전 검증: if heroic 조건 (예: 높은 repute & clues) 부여
    if (state.repute >= 5 && state.clues >= 3) state.flags.heroic = true;
    // 다음 노드로 라우팅
    state.current = 'ending_router';
  }

  // 만약 선택 후 곧바로 엔딩 플래그가 셋팅되었다면 라우팅을 'ending_router'로 바꿀 수 있다.
  if (state.current === 'finalize' || state.current === 'show_ending') {
    // handled above in render loop
  }

  appendLog(`선택: ${choice.text}`);
  render();
}

/* 버튼 바인딩 */
document.getElementById('restartBtn').onclick = ()=>{
  if (confirm('정말로 처음부터 시작하시겠습니까?')) {
    state.current = 'intro_wake';
    state.flags = {};
    state.repute = 0;
    state.clues = 0;
    state.history = [];
    state.timeStart = Date.now();
    render();
    appendLog('게임 재시작');
  }
};

document.getElementById('hintBtn').onclick = ()=>{
  const cur = story[state.current];
  let hint = '상황을 천천히 살피세요.';
  if (cur && cur.title && cur.title.includes('관찰')) hint = '호감을 쌓고 단서를 모아 북쪽 관문을 노리세요.';
  if (cur && cur.title && cur.title.includes('위장')) hint = '위장은 빠르지만 감시가 늘어납니다. 단서를 확보하세요.';
  if (cur && cur.title && (cur.title.includes('직접') || cur.title.includes('과학'))) hint = '직접 대면은 빠르지만 변형의 위험이 있습니다.';
  alert('힌트: ' + hint);
};

/* export HTML 기능 (단순 다운로드) */
document.getElementById('exportBtn').onclick = ()=>{
  const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'banana_world_expanded.html';
  a.click();
  URL.revokeObjectURL(url);
};

/* 초기 시작 */
render(); appendLog('새 게임을 시작합니다.'); setInterval(renderHUD, 1000);

</script>
</body>
</html>
